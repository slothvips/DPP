# 密钥更换机制

本文档描述 DPP 扩展中端到端加密(E2EE)同步功能的密钥更换机制。

## 加密基础

- **算法**: AES-GCM 256-bit
- **IV**: 每次加密随机生成 12 字节
- **密钥存储**: 本地 IndexedDB `settings` 表
- **密钥标识**: SHA-256 哈希前 8 字节 (`keyHash`)

## keyHash 的作用

每条同步操作附带 `keyHash` 字段，用于标识加密该数据的密钥。拉取数据时，系统通过比对哈希判断是否能用当前密钥解密：

```typescript
if (op.keyHash && op.keyHash !== currentKeyHash) {
  // 跳过无法解密的数据
  return null;
}
```

## 两种更换模式

| 模式 | 角色 | 行为 | 适用场景 |
|------|------|------|----------|
| **Authority（管理员）** | 数据权威源 | 保留本地数据，重新加密上传 | 发起密钥轮换的人 |
| **Member（普通成员）** | 数据接收方 | 清空本地数据，从服务器拉取 | 接收新密钥的团队成员 |

## 更换流程

### 管理员模式

```
1. 生成或输入新密钥
2. 存储新密钥到本地
3. resetSyncState() - 清除同步元数据和操作队列
4. regenerateOperations() - 为所有本地数据生成 create 操作
5. push() - 用新密钥加密后推送到服务器
```

### 普通成员模式

```
1. 输入新密钥（从管理员处获取）
2. 存储新密钥到本地
3. clearAllData() - 清空本地数据表和同步状态
4. pull() - 从服务器拉取新密钥加密的数据
```

## 核心方法

| 方法 | 位置 | 作用 |
|------|------|------|
| `resetSyncState()` | SyncEngine.ts | 清除 syncMetadata、operations、deferred_ops 表 |
| `clearAllData()` | SyncEngine.ts | 清除同步状态 + 所有业务数据表 |
| `regenerateOperations()` | SyncEngine.ts | 遍历业务表，为每条记录生成 create 操作 |
| `getKeyHash()` | encryption.ts | 计算密钥哈希用于标识 |

## 流程图

```
┌─────────────────────────────────────────────────────────────┐
│                    密钥更换流程                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  管理员 (Authority)              普通成员 (Member)           │
│  ┌─────────────────┐            ┌─────────────────┐        │
│  │ 1. 生成/输入新密钥 │            │ 1. 输入新密钥     │        │
│  │ 2. 存储新密钥     │            │ 2. 存储新密钥     │        │
│  │ 3. resetSyncState│            │ 3. clearAllData │        │
│  │ 4. regenerateOps │            │ 4. pull()       │        │
│  │ 5. push()        │            │    ↓            │        │
│  │    ↓             │            │ 从服务器拉取数据  │        │
│  │ 用新密钥加密上传   │            └─────────────────┘        │
│  └─────────────────┘                                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 安全设计

1. **keyHash 校验**: 拉取时跳过与当前密钥不匹配的数据
2. **二次确认**: UI 要求输入"确认更换密钥"才能执行
3. **风险提示**: 明确告知操作会中断团队同步、可能覆盖数据
4. **盲存储**: 服务器只存储加密 blob，无法解密内容

## 相关文件

- `src/lib/crypto/encryption.ts` - 加密/解密核心函数
- `src/lib/sync/SyncEngine.ts` - 同步引擎
- `src/features/settings/components/SyncKeyManager.tsx` - 密钥管理 UI
