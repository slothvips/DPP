# Ralph Progress - AI Assistant Feature

## Project: DPP Browser Extension - AI Assistant
## Branch: ralph/ai-assistant

## Progress

- [x] US-001: 创建 AI 助手目录结构和基础类型定义
- [x] US-002: 实现模型提供商接口和 Ollama 实现
- [x] US-003: 实现统一工具定义格式
- [x] US-004: 实现链接管理工具
- [x] US-005: 实现 Jenkins 管理工具
- [x] US-006: 实现便签管理工具
- [x] US-007: 实现标签管理工具
- [x] US-008: 实现录屏管理工具
- [x] US-009: 实现热榜和同步工具
- [x] US-010: 实现系统提示词生成器
- [x] US-011: 实现 AI 对话核心逻辑 Hook
- [x] US-012: 实现 AI 助手 Tab 入口和对话界面
- [x] US-013: 实现 AI 配置页面
- [x] US-014: 实现危险操作确认弹窗

## 2026-02-18 - US-001
- Created src/features/aiAssistant/types.ts with ChatMessage, ToolCall, ChatResponse, AIConfig types
- Created src/lib/ai/types.ts with ModelProvider interface and tool definition types (AIToolDefinition, ToolParameter, Ollama API types)
- **Learnings for future iterations:**
  - This codebase follows feature-based structure: types.ts, api.ts, components/, hooks/ in each feature directory
  - Use @/ alias for imports from src/
  - Model provider types (ModelProvider, ChatMessage, etc.) are in src/lib/ai/types.ts while feature-specific types go in src/features/{feature}/types.ts
  - Need to import AIToolDefinition from @/lib/ai/types in feature types

## 2026-02-18 - US-002
- Created src/lib/ai/ollama.ts with OllamaProvider class
- Supports /api/chat endpoint with streaming via onChunk callback
- Supports /api/tags for listing available models
- Includes healthCheck() method for connection testing
- Created src/lib/ai/index.ts for exports
- **Learnings for future iterations:**
  - Use http and httpPost from @/lib/http for API calls
  - Use logger from @/utils/logger for logging
  - Streaming is handled by reading the response body as a ReadableStream

## 2026-02-18 - US-003
- Created src/lib/ai/tools.ts with ToolRegistry class
- Implements tool registration, execution, and listing
- Provides toOllamaTools() conversion function
- Includes registerTool() decorator and createToolParameter() helper
- Added requiresConfirmation flag for dangerous operations
- **Learnings for future iterations:**
  - Tool handlers should return Promise<T> and accept Record<string, unknown>
  - Use toolRegistry.execute(name, args) to run tools
  - Set requiresConfirmation: true for dangerous operations

## 2026-02-18 - US-004
- Created src/lib/ai/tools/links.ts with all link management tools
- links_list: List all links with keyword and tag filtering, returns usage stats
- links_add: Add new link with name, URL, note, tags
- links_update: Update existing link (name, URL, note, tags)
- links_delete: Soft delete link (marks as deleted, requires confirmation)
- links_visit: Open link in new tab and record statistics
- **Learnings for future iterations:**
  - Use db.transaction('rw', table, ...) for write transactions
  - Cast db.linkTags as Table<LinkTagItem, [string, string]> for transaction type compatibility
  - Use openLink from @/features/links/utils to open links with security validation

## 2026-02-18 - US-005
- Created src/lib/ai/tools/jenkins.ts with Jenkins management tools
- jenkins_list_jobs: List all jobs with keyword filtering
- jenkins_list_builds: Get build history for a job with limit
- jenkins_trigger_build: Trigger a build (requires confirmation)
- **Learnings for future iterations:**
  - Use JenkinsService from @/features/jenkins/service to interact with Jenkins
  - Jobs are stored in db.jobs table with url as primary key
  - Builds are stored in db.myBuilds table

## 2026-02-18 - US-006
- Created src/lib/ai/tools/blackboard.ts with blackboard management tools
- blackboard_list: List all blackboard items
- blackboard_add: Add new item with content and optional pinned flag
- blackboard_update: Update item content and pinned status
- blackboard_delete: Delete item (requires confirmation)
- **Learnings for future iterations:**
  - Blackboard items are stored in db.blackboard table
  - Use db.blackboard.orderBy().reverse().sortBy() for ordering

## 2026-02-18 - US-007
- Created src/lib/ai/tools/tags.ts with tags management tools
- tags_list: List all tags with link and job counts
- tags_add: Create new tag with name and color (validates uniqueness)
- tags_delete: Delete tag and remove all link/job associations (requires confirmation)
- **Learnings for future iterations:**
  - Tags are stored in db.tags table
  - Link-tag associations in db.linkTags, job-tag in db.jobTags
  - Use soft delete for tags (mark deletedAt)

## 2026-02-18 - US-008
- Created src/lib/ai/tools/recorder.ts with recorder management tools
- recorder_list: List all recordings with metadata (title, url, duration, etc.)
- recorder_start: Start recording (requires confirmation)
- recorder_stop: Stop recording
- **Learnings for future iterations:**
  - Use browser.runtime.sendMessage to communicate with background script
  - Recorder messages use RECORDER_* prefix
  - Can get current tab with browser.tabs.query({active: true, currentWindow: true})

## 2026-02-18 - US-009
- Created src/lib/ai/tools/hotnews.ts with hotnews and sync tools
- hotnews_get: Get hot news from cache (user must open Hot News tab first to fetch data)
- sync_trigger: Trigger global sync using syncEngine.push() and syncEngine.pull()
- **Learnings for future iterations:**
  - Hot news data is stored in db.hotNews table
  - Use syncEngine from @/db for sync operations

## 2026-02-19 - US-011
- Created src/features/aiAssistant/hooks/useAIChat.ts with core conversation logic
- Implements sendMessage, tool execution, dangerous operation confirmation, and streaming support
- AIChatStatus: idle, loading, streaming, error, confirming
- Added PendingToolCall interface for confirmation workflow
- Uses refs to avoid circular dependency warnings between callbacks
- **Learnings for future iterations:**
  - Use refs for callbacks to avoid react-hooks/exhaustive-deps warnings when callbacks call each other
  - Use db.settings.where('key').equals('key').first() for dynamic settings keys
  - generateSystemPrompt is in @/lib/ai/prompt, not @/lib/ai/tools
  - Feature types (src/features/aiAssistant/types.ts) must match lib types (src/lib/ai/types.ts) for ToolCall

## 2026-02-19 - US-012
- Added AI Assistant Tab in App.tsx (src/entrypoints/popup/App.tsx)
- Created AIAssistantView component (src/features/aiAssistant/components/AIAssistantView.tsx)
- Displays conversation history with user/assistant/tool message roles
- Shows streaming AI responses with auto-scroll
- Shows "思考中..." loading state during AI processing
- Shows connection status indicator (Wifi/WifiOff icons)
- Supports sending messages with Enter, new line with Shift+Enter
- Clear button to reset conversation
- **Learnings for future iterations:**
  - Use data-testid attributes for browser testing automation
  - Feature views go in src/features/{feature}/components/{Feature}View.tsx
  - Always use @/ alias for imports from src/
  - Export components from index.ts in the components folder
  - Use refs (messagesEndRef) for auto-scrolling to bottom on new messages
  - useAIChat hook provides isConnected, status, error for UI states

## 2026-02-19 - US-013
- Created AIConfigDialog component (src/features/aiAssistant/components/AIConfigDialog.tsx)
- Supports configuring Ollama service URL (default http://localhost:11434)
- Supports selecting model from available models fetched from Ollama
- Includes "Test Connection" button to verify connectivity
- Shows connection status (success/error) after testing
- Settings are saved to db.settings with keys: ai_ollama_base_url, ai_ollama_model
- Added Settings button to AIAssistantView header to open config dialog
- Shows "需要配置 AI 服务" prompt when config is missing
- Added isAIConfigConfigured() helper to check if AI settings exist
- **Learnings for future iterations:**
  - Use Dialog from @/components/ui/dialog for modal dialogs
  - Use db.settings.put({ key, value }) to save settings
  - Use db.settings.where('key').equals('key').first() to read settings
  - OllamaProvider.listModels() returns Model[] with name property
  - Need to add Settings icon to AIAssistantView imports when adding config button

## 2026-02-19 - US-014
- Created ToolConfirmationDialog component (src/features/aiAssistant/components/ToolConfirmationDialog.tsx)
- Shows confirmation dialog when AI requests dangerous operations
- Supports: links_delete, blackboard_delete, tags_delete, jenkins_trigger_build, recorder_start
- Dialog displays operation title, description, impact, and parameters
- Provides Confirm and Cancel buttons
- Handles dialog close (Escape or click outside) as cancel
- Integrated into AIAssistantView with pendingToolCall, confirmToolCall, cancelToolCall from useAIChat
- Disabled input field during confirmation to prevent concurrent operations
- **Learnings for future iterations:**
  - useAIChat hook already has pendingToolCall, confirmToolCall, and cancelToolCall for confirmation workflow
  - Use status === 'confirming' to show pending confirmation state in UI
  - Use Dialog's onOpenChange prop to handle cancel on close
  - Show different confirmation text based on tool (确认删除 vs 确认构建 vs 开始录制)
  - Input should be disabled during confirmation to prevent message sending
